<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    :root {
      --bg: #f0f2f5; --card: #ffffff; --text: #1f2937; --text-mid: #6b7280;
      --accent: #2563eb; --border: #e5e7eb; --success: #10b981; --error: #ef4444; --warn: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; }
    
    .container { width: 100%; max-width: 600px; padding: 25px; background: var(--card); min-height: 100vh; position: relative; }
    @media (min-width: 600px) { body { align-items: center; padding: 20px; } .container { min-height: auto; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid var(--border); } }

    /* HEADER & SYNC */
    .header { text-align: center; margin-bottom: 20px; }
    .header-row { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 5px; }
    h2 { font-size: 24px; font-weight: 800; color: #111827; }
    .sync-btn { 
        background: #eff6ff; border: 1px solid #bfdbfe; color: var(--accent); 
        width: 42px; height: 42px; border-radius: 50%; display: flex; 
        align-items: center; justify-content: center; cursor: pointer; position: relative;
    }
    .sync-loader { position: absolute; inset: 0; display: none; transform: rotate(-90deg); }
    .sync-loader circle { fill: none; stroke: var(--accent); stroke-width: 3.5; stroke-dasharray: 113; stroke-dashoffset: 113; stroke-linecap: round; }
    .is-loading .sync-loader { display: block; }
    .is-loading .sync-loader circle { animation: dash 1.5s ease-in-out infinite; }
    @keyframes dash { 0% { stroke-dashoffset: 113; } 50% { stroke-dashoffset: 30; } 100% { stroke-dashoffset: 113; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .is-loading i { animation: spin 1.5s linear infinite; }

    /* PROGRESS BAR */
    .progress-container { margin: 20px 0; }
    .progress-bg { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: var(--accent); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

    /* STEPS & INPUTS */
    .step { display: none; animation: fadeIn 0.3s ease-out; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    label { display: block; margin: 24px 0 8px; font-weight: 600; font-size: 15px; color: #374151; }
    .input-group { position: relative; }
    .input-group i:not(#scannerIcon) { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
    input, select { width: 100%; padding: 14px 15px 14px 46px; border-radius: 12px; border: 1px solid var(--border); font-size: 16px; outline: none; background: #fff; transition: 0.2s; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    #scannerIcon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 22px; color: var(--accent); padding: 5px; cursor: pointer; z-index: 10; }

    .type-buttons { display: flex; gap: 12px; }
    .type-btn { flex: 1; padding: 16px; border-radius: 12px; border: 2px solid var(--border); background: white; font-weight: 800; cursor: pointer; text-align: center; color: var(--text-mid); transition: 0.2s; }
    .type-btn.selected { border-color: var(--accent); color: var(--accent); background: #eff6ff; }

    .actions { display: flex; gap: 12px; margin-top: 35px; }
    .btn { flex: 1; padding: 18px; border-radius: 14px; font-weight: 700; border: none; cursor: pointer; font-size: 16px; transition: 0.2s; }
    .btn-prev { background: #f3f4f6; color: #374151; }
    .btn-next { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* REVIEW CARD */
    .review-card { background: #f8fafc; padding: 20px; border-radius: 14px; border: 1px solid #e2e8f0; line-height: 1.8; color: #4b5563; }
    .review-item { display: flex; justify-content: space-between; border-bottom: 1px solid #edf2f7; padding: 5px 0; }
    .review-item b { color: var(--text); }

    /* MODAL */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 30000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
    .modal-content { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; position: relative; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-mid); }

    /* TOAST */
    #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; width: 90%; max-width: 400px; }
    .toast { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 10px; border-left: 6px solid var(--accent); animation: slideIn 0.3s forwards; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    #scanner-container { display: none; position: fixed; inset: 0; background: black; z-index: 10000; }
    #reader { width: 100%; height: 100%; }
  </style>
</head>
<body>

  <div id="toast-container"></div>

  <div class="container">
    <button onclick="openAddModal()" style="position: absolute; top: 20px; right: 20px; background: var(--success); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; font-size: 22px; cursor: pointer; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); z-index: 5;">+</button>

    <div class="header">
      <div class="header-row">
        <h2>Inventory Logger</h2>
        <button id="refreshBtn" class="sync-btn" onclick="forceUpdateDB()">
          <svg class="sync-loader" viewBox="0 0 42 42"><circle cx="21" cy="21" r="18"></circle></svg>
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <p id="statusTxt" style="font-size: 13px; font-weight: 600;">Checking Status...</p>
      <p style="font-size: 11px; color: var(--text-mid); margin-top: 4px;">Pending Uploads: <span id="qCount" style="font-weight: 800; color: var(--warn);">0</span></p>
    </div>

    <div class="progress-container"><div class="progress-bg"><div class="progress-fill" id="pFill"></div></div></div>

    <form id="inventoryForm">
      <!-- STEP 1 -->
      <div class="step active">
        <label>Scan Product Barcode</label>
        <div class="input-group">
          <i class="fas fa-barcode"></i>
          <input type="text" id="barcode" placeholder="Scan or type barcode" autocomplete="off">
          <i class="fas fa-camera" id="scannerIcon"></i>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="step">
        <div id="pReview" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px; display:none;">
            <div id="detName" style="font-weight:800; color:var(--accent); font-size:18px;"></div>
            <div id="detBarcode" style="font-size:13px; color:var(--text-mid); margin-top:2px;"></div>
        </div>
        <label>Staff Name</label>
        <div class="input-group"><i class="fas fa-user"></i>
          <select id="identity">
            <option value="">Select Staff...</option>
            <option>SATTAR</option><option>ANAS</option><option>KUMAR</option>
            <option>JOWEL</option><option>SHAHID</option><option>MUHAMMED</option>
            <option>AROOS</option><option>MOIDU</option><option>SALAM</option>
            <option>RAMSHAD</option><option>ANWAR</option><option>MANIK</option>
          </select>
        </div>
        <label>Item Type</label>
        <div class="type-buttons">
          <div class="type-btn" id="btnExp" onclick="setType('Expiry')">Expiry</div>
          <div class="type-btn" id="btnDmg" onclick="setType('Damage')">Damage</div>
        </div>
        <input type="hidden" id="entryType">
        <label>Quantity</label>
        <div class="input-group"><i class="fas fa-hashtag"></i><input type="number" id="qty" value="1" min="1"></div>
        <label>Expiry Date</label>
        <div class="input-group"><i class="fas fa-calendar-alt"></i><input type="date" id="expDate"></div>
      </div>

      <!-- STEP 3 -->
      <div class="step">
        <label>Storage Location</label>
        <div class="input-group"><i class="fas fa-map-marker-alt"></i>
          <select id="location">
            <option value="">Select Location...</option>
            <option>Front side</option><option>Back side</option><option>On Display</option>
          </select>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="step">
        <label>Review Entry Details</label>
        <div class="review-card" id="finalRev"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-prev" id="prevBtn" onclick="move(-1)">Back</button>
        <button type="button" class="btn btn-next" id="nextBtn" onclick="move(1)">Next</button>
        <button type="submit" class="btn btn-next" id="subBtn" style="display:none">Confirm & Submit</button>
      </div>
    </form>
  </div>

  <!-- ADD PRODUCT MODAL -->
  <div id="addModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeAddModal()">&times;</span>
        <h3 style="font-weight:800; margin-bottom:15px;">Add New Product</h3>
        <label>Barcode</label><input type="text" id="nb" style="padding-left:15px;">
        <label>Name</label><input type="text" id="nn" style="padding-left:15px;">
        <label>Supplier</label><input type="text" id="ns" list="supOptions" style="padding-left:15px;" placeholder="Search or Type..."><datalist id="supOptions"></datalist>
        <label>Admin Password</label><input type="password" id="ap" style="padding-left:15px;">
        <button onclick="saveNew()" class="btn btn-next" style="width:100%; margin-top:20px;">Authorize & Save</button>
    </div>
  </div>

  <div id="loader" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:40000; align-items:center; justify-content:center; flex-direction:column; font-weight:800;">
    <div style="width:45px; height:45px; border:5px solid #ddd; border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:10px;"></div>
    Submitting...
  </div>

  <div id="scanner-container">
    <div id="reader"></div>
    <button onclick="stopScan()" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); padding:16px 40px; border-radius:30px; border:none; font-weight:800; background:white;">Cancel Scan</button>
  </div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycby__866_Y_0XFiaPPCUaX6U1oZK329Ek6SRg9iU4u-aq5ARhxmkTmIHq6gvTpxXMf-8Lw/exec";
    const OFF_KEY = "inventory_offline_queue";
    let step = 0, pMap = {}, scanner = null;
    const steps = document.querySelectorAll('.step');

    window.onload = () => {
      const saved = localStorage.getItem('inventory_db'); if(saved) pMap = JSON.parse(saved);
      ['barcode','identity','location','qty','expDate','entryType'].forEach(id => {
        const el = document.getElementById(id); el.oninput = el.onchange = updateNav;
      });
      document.getElementById('scannerIcon').onclick = startScan;
      document.getElementById('expDate').valueAsDate = new Date();
      updateStatus(); updateStep(); updateQC(); forceUpdateDB();
    };

    function showToast(m, t='success') {
      const c = document.getElementById('toast-container'), toast = document.createElement('div');
      toast.className = `toast ${t}`;
      toast.innerHTML = `<i class="fas fa-${t==='success'?'check-circle':'exclamation-triangle'}" style="color:${t==='success'?'var(--success)':'var(--error)'}"></i><span>${m}</span>`;
      c.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 3000);
    }

    function updateStatus() {
      const o = navigator.onLine, e = document.getElementById('statusTxt');
      e.innerText = o ? "● System Online" : "○ System Offline"; e.style.color = o ? "var(--success)" : "var(--error)";
      if(o) sync();
    }
    window.ononline = window.onoffline = updateStatus;

    async function forceUpdateDB() {
      if(!navigator.onLine) return;
      const b = document.getElementById('refreshBtn'); b.classList.add('is-loading');
      try {
        const r = await fetch(`${API}?action=getProducts&_cb=${Date.now()}`), d = await r.json();
        pMap = d.products; localStorage.setItem('inventory_db', JSON.stringify(d.products));
        const l = document.getElementById('supOptions'); l.innerHTML = "";
        if(d.suppliers) d.suppliers.forEach(s => { const o = document.createElement('option'); o.value = s; l.appendChild(o); });
        showToast("Database Synced");
      } catch(e) { console.error(e); }
      finally { setTimeout(() => b.classList.remove('is-loading'), 500); }
    }

    function updateStep() {
      steps.forEach((s, i) => s.classList.toggle('active', i === step));
      document.getElementById('pFill').style.width = `${((step + 1) / steps.length) * 100}%`;
      document.getElementById('prevBtn').disabled = step === 0;
      document.getElementById('nextBtn').style.display = step === 3 ? 'none' : 'block';
      document.getElementById('subBtn').style.display = step === 3 ? 'block' : 'none';
      
      if(step === 1) {
        const b = document.getElementById('barcode').value.trim();
        document.getElementById('detName').innerText = pMap[b] || "Unknown Item";
        document.getElementById('detBarcode').innerText = `Barcode: ${b}`;
        document.getElementById('pReview').style.display = 'block';
      }
      if(step === 3) {
        const b = document.getElementById('barcode').value.trim();
        document.getElementById('finalRev').innerHTML = `
            <div class="review-item"><b>Item:</b> <span>${pMap[b]}</span></div>
            <div class="review-item"><b>Staff:</b> <span>${document.getElementById('identity').value}</span></div>
            <div class="review-item"><b>Type:</b> <span>${document.getElementById('entryType').value}</span></div>
            <div class="review-item"><b>Quantity:</b> <span>${document.getElementById('qty').value}</span></div>
            <div class="review-item"><b>Expiry:</b> <span>${document.getElementById('expDate').value}</span></div>
            <div class="review-item" style="border:none"><b>Location:</b> <span>${document.getElementById('location').value}</span></div>`;
      }
      updateNav();
    }

    function updateNav() {
      const v = (id) => document.getElementById(id).value.trim(); let ok = false;
      if(step === 0) ok = v('barcode') !== "";
      if(step === 1) ok = v('identity') !== "" && v('entryType') !== "" && v('qty') > 0 && v('expDate') !== "";
      if(step === 2) ok = v('location') !== "";
      if(step === 3) ok = true;
      document.getElementById('nextBtn').disabled = !ok;
    }

    function move(d) {
      if(d === 1 && step === 0 && !pMap[document.getElementById('barcode').value.trim()]) return showToast("Product not in DB!", "error");
      step += d; updateStep();
    }

    function setType(t) {
      document.getElementById('entryType').value = t;
      document.getElementById('btnExp').classList.toggle('selected', t === 'Expiry');
      document.getElementById('btnDmg').classList.toggle('selected', t === 'Damage');
      updateNav();
    }

    document.getElementById('inventoryForm').onsubmit = async (e) => {
      e.preventDefault();
      document.getElementById('loader').style.display = 'flex';
      const d = { 
          barcode: document.getElementById('barcode').value, 
          identity: document.getElementById('identity').value, 
          type: document.getElementById('entryType').value, 
          quantity: document.getElementById('qty').value, 
          expiryDate: document.getElementById('expDate').value, 
          location: document.getElementById('location').value, 
          productName: pMap[document.getElementById('barcode').value], 
          timestamp: new Date().toISOString() 
      };
      if(!navigator.onLine) { q(d); document.getElementById('loader').style.display = 'none'; return; }
      try { 
          const r = await fetch(API, { method:'POST', body:JSON.stringify(d) }); 
          const res = await r.json();
          if(res.status === 'success') { showToast("Logged Successfully!"); reset(); } 
      } catch(e) { q(d); }
      finally { document.getElementById('loader').style.display = 'none'; }
    };

    function q(d) { const l = JSON.parse(localStorage.getItem(OFF_KEY) || "[]"); l.push(d); localStorage.setItem(OFF_KEY, JSON.stringify(l)); updateQC(); showToast("Offline saved to queue", "warning"); reset(); }
    function sync() { const l = JSON.parse(localStorage.getItem(OFF_KEY) || "[]"); if(!l.length) return; fetch(API, {method:'POST', body:JSON.stringify(l[0])}).then(r=>r.json()).then(r=>{ if(r.status==='success') { l.shift(); localStorage.setItem(OFF_KEY, JSON.stringify(l)); updateQC(); sync(); } }); }
    function updateQC() { document.getElementById('qCount').innerText = JSON.parse(localStorage.getItem(OFF_KEY) || "[]").length; }
    function reset() { document.getElementById('inventoryForm').reset(); document.getElementById('entryType').value = ""; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected')); step = 0; updateStep(); }
    
    function openAddModal() { document.getElementById('addModal').style.display='flex'; document.getElementById('nb').value = document.getElementById('barcode').value; }
    function closeAddModal() { document.getElementById('addModal').style.display='none'; document.getElementById('ap').value = ""; }
    
    async function saveNew() {
      const b = document.getElementById('nb').value, n = document.getElementById('nn').value, s = document.getElementById('ns').value, p = document.getElementById('ap').value;
      if(!b || !n || !p) return showToast("Fields required", "error");
      document.getElementById('loader').style.display = 'flex';
      try { 
          const r = await fetch(API, {method:'POST', body:JSON.stringify({action:'addProduct', barcode:b, name:n, supplier:s, password:p})}); 
          const res = await r.json(); 
          if(res.status==='success') { showToast("Product Added!"); closeAddModal(); forceUpdateDB(); } else showToast(res.message, "error"); 
      } catch(e) { showToast("Error connecting", "error"); }
      finally { document.getElementById('loader').style.display = 'none'; }
    }
    
    function startScan() {
      document.getElementById('scanner-container').style.display = 'flex'; scanner = new Html5Qrcode("reader");
      scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => { document.getElementById('barcode').value = t; stopScan(); if(pMap[t]) move(1); else showToast("Not in DB", "error"); });
    }
    function stopScan() { if(scanner) scanner.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; scanner = null; }); }
  </script>
</body>
</html>
