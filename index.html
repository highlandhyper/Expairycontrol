<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" type="image/png">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <style>
    /* --- CSS VARIABLES --- */
    :root {
      --bg-light: #f0f2f5; 
      --card-bg: #ffffff; 
      --text-dark: #1f2937; 
      --text-mid: #6b7280;
      --accent-color: #2563eb; 
      --accent-hover: #1d4ed8; 
      --border-color: #e5e7eb;
      --error-red: #ef4444; 
      --success-green: #10b981; 
      --warning-orange: #f59e0b;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background: var(--bg-light); 
      color: var(--text-dark); 
      display: flex; justify-content: center; align-items: flex-start; 
      min-height: 100vh; 
    }
    
    .form-container { 
      width: 100%; max-width: 600px; margin: 0; padding: 25px; 
      background: var(--card-bg); min-height: 100vh; position: relative; 
    }
    
    @media (min-width: 600px) { 
      body { align-items: center; padding: 20px; } 
      .form-container { 
        min-height: auto; 
        border-radius: 20px; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
        border: 1px solid var(--border-color); 
        margin: auto; padding: 40px; 
      } 
    }

    /* --- TOAST NOTIFICATIONS --- */
    #toast-container {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
      z-index: 99999; width: 90%; max-width: 420px; 
      display: flex; flex-direction: column; gap: 12px; pointer-events: none;
    }
    .toast {
      background: white; color: var(--text-dark); padding: 16px 20px; border-radius: 12px; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: flex; align-items: center; gap: 15px; font-size: 15px; font-weight: 600;
      animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0;
      border-left: 6px solid transparent; pointer-events: auto;
    }
    .toast.success { border-left-color: var(--success-green); }
    .toast.error { border-left-color: var(--error-red); }
    .toast.warning { border-left-color: var(--warning-orange); }
    @keyframes toastSlideIn { to { opacity: 1; transform: translateY(0); } }
    .toast.fade-out { animation: toastFadeOut 0.3s ease-in forwards; }
    @keyframes toastFadeOut { to { opacity: 0; transform: translateY(-10px); } }

    /* --- UI ELEMENTS --- */
    .form-header { margin-bottom: 25px; text-align: center; }
    h2 { margin: 0 0 5px 0; font-size: 24px; display: flex; justify-content: center; align-items: center; gap: 10px; font-weight: 800; color: #111827; }
    .subtitle { color: var(--text-mid); font-size: 14px; margin-top: 5px; }
    
    .status-badge { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .status-online { background: #dcfce7; color: #166534; }
    .status-offline { background: #fee2e2; color: #991b1b; }
    
    /* REFRESH BUTTON WITH INTERNAL PROGRESS */
    .refresh-button-header { 
        background: #eff6ff; 
        border: 1px solid #bfdbfe; 
        color: var(--accent-color); 
        width: 42px; 
        height: 42px; 
        border-radius: 50%; 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 16px; 
        cursor: pointer; 
        transition: 0.2s; 
        margin-left: 8px; 
        position: relative;
        padding: 0;
        outline: none;
    }
    .refresh-button-header:active { transform: scale(0.9); }
    .refresh-button-header:disabled { cursor: not-allowed; }

    /* Centered SVG Loader */
    .sync-loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        pointer-events: none;
        transform: rotate(-90deg);
    }
    .sync-loader circle {
        fill: none;
        stroke: var(--accent-color);
        stroke-width: 3;
        stroke-linecap: round;
        /* Circumference of r=17.5 is ~110 */
        stroke-dasharray: 110;
        stroke-dashoffset: 110;
    }
    
    /* Loading States */
    .refresh-button-header.is-loading .sync-loader { 
        display: block; 
    }
    .refresh-button-header.is-loading .sync-loader circle {
        animation: dashAnim 1.5s ease-in-out infinite;
    }
    .refresh-button-header.is-loading i {
        animation: rotateIcon 1.5s linear infinite;
        color: var(--text-mid);
    }

    @keyframes dashAnim {
        0% { stroke-dashoffset: 110; }
        50% { stroke-dashoffset: 20; }
        100% { stroke-dashoffset: 110; }
    }
    @keyframes rotateIcon { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }

    .progress-container { margin-bottom: 30px; text-align: center; }
    .progress-bar-bg { width: 100%; height: 6px; background-color: #e5e7eb; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
    .progress-bar-fill { height: 100%; width: 0%; background-color: var(--accent-color); transition: width 0.4s ease; }
    .progress-text { font-size: 13px; color: var(--text-mid); font-weight: 600; text-transform: uppercase; }
    
    .form-step { display: none; animation: fadeIn 0.4s ease-out; }
    .form-step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    
    label { display: block; margin-top: 24px; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: #374151; }
    .input-group { position: relative; }
    .input-group i:not(#scannerIcon) { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 18px; pointer-events: none; }
    
    input, select { 
        width: 100%; padding: 16px 16px 16px 48px; border-radius: 12px; 
        border: 1px solid var(--border-color); background: #ffffff; color: var(--text-dark); 
        font-size: 16px; appearance: none; transition: 0.2s;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    
    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 20px; padding-right: 40px; }
    
    #scannerIcon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--accent-color); font-size: 24px; padding: 8px; cursor: pointer; z-index: 5; }

    .item-type-buttons { display: flex; gap: 15px; margin-top: 10px; }
    .type-button { flex: 1; padding: 16px; border-radius: 12px; border: 2px solid var(--border-color); background: #fff; color: var(--text-mid); font-weight: 700; cursor: pointer; transition: all 0.2s; text-align: center; }
    .type-button.selected { background-color: #eff6ff; color: var(--accent-color); border-color: var(--accent-color); }
    
    .form-actions { display: flex; gap: 15px; margin-top: 40px; }
    .form-actions button { flex: 1; padding: 18px; border-radius: 14px; font-size: 16px; font-weight: 700; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: 0.2s; }
    .prev-button { background-color: #f3f4f6; color: #374151; }
    .next-button, .log-button { background-color: var(--accent-color); color: white; }
    .form-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .product-details { background-color: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin: 20px 0; }
    .product-details .product-name { font-size: 18px; color: var(--accent-color); font-weight: 700; margin-bottom: 10px; display: block; }
    
    .review-summary { background: #f8fafc; padding: 25px; border-radius: 16px; display: grid; gap: 18px; font-size: 15px; border: 1px solid #e2e8f0; }
    .review-item i { width: 24px; color: var(--accent-color); text-align: center; margin-right: 10px; }
    
    #scanner-container { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 10000; flex-direction: column; justify-content: center; }
    #reader { width: 100%; height: 100%; object-fit: cover; }
    #close-scanner { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.2); border: 2px solid #fff; color: white; padding: 14px 35px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    
    .loader-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 20000; justify-content: center; align-items: center; flex-direction: column; font-weight: 600; }
    .loader-overlay.active { display: flex; }
    .loader-spinner { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid var(--accent-color); border-radius: 50%; animation: rotateIcon 0.8s linear infinite; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div id="toast-container"></div>

  <div class="form-container">
    <div class="form-header">
      <h2>
        Inventory Logger
        <span id="connectionStatus" class="status-badge status-online">Online</span>
        <button type="button" id="refreshBtn" class="refresh-button-header" onclick="forceUpdateDB()">
            <!-- SVG viewBox adjusted to match button size (42x42) -->
            <svg class="sync-loader" viewBox="0 0 42 42">
                <circle cx="21" cy="21" r="17.5"></circle>
            </svg>
            <i class="fas fa-sync-alt"></i>
        </button>
      </h2>
      <p class="subtitle">Pending Uploads: <span id="queueCount">0</span></p>
    </div>

    <div class="progress-container">
      <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: 0%;"></div></div>
      <div class="progress-text"><span id="currentStepText">Step 1</span></div>
    </div>

    <form id="inventoryForm">
      <div class="form-step active" id="step1">
        <label for="barcode">Scan Product</label>
        <div class="input-group">
          <i class="fas fa-barcode"></i> 
          <input type="text" id="barcode" name="barcode" placeholder="Scan or type code" autocomplete="off" required>
          <i class="fas fa-camera" id="scannerIcon" title="Open Camera"></i> 
        </div>
      </div>

      <div class="form-step" id="step2">
        <div class="product-details" id="product-details-display-step2" style="display: none;">
          <div class="product-name" id="product-name-summary2"></div>
          <div class="detail-row" style="font-size: 14px; color: #6b7280;">
            <i class="fas fa-tag"></i> <span id="barcode-summary2"></span>
          </div>
        </div>
        
        <label for="identity">Staff Name</label>
        <div class="input-group">
          <i class="fas fa-user"></i>
          <select id="identity" name="identity" required>
            <option value="">Select Staff...</option>
            <option>SATTAR</option><option>ANAS</option><option>KUMAR</option>
            <option>JOWEL</option><option>SHAHID</option><option>MUHAMMED</option>
            <option>AROOS</option><option>MOIDU</option><option>SALAM</option>
            <option>RAMSHAD</option><option>ANWAR</option><option>MANIK</option>
          </select>
        </div>

        <label>Item Type</label>
        <div class="item-type-buttons">
          <div class="type-button" id="expBtn" onclick="setType('Expiry')">Expiry</div>
          <div class="type-button" id="dmgBtn" onclick="setType('Damage')">Damage</div>
        </div>
        <input type="hidden" name="type" id="entryType" required>

        <label for="quantity">Quantity</label>
        <div class="input-group">
          <i class="fas fa-hashtag"></i>
          <input type="number" id="quantity" name="quantity" placeholder="1" required min="1" value="1" inputmode="numeric">
        </div>

        <label for="expiryDate">Expiry Date</label>
        <div class="input-group">
          <i class="fas fa-calendar-alt"></i>
          <input type="date" id="expiryDate" name="expiryDate" required>
        </div>
      </div>

      <div class="form-step" id="step3">
        <label for="location">Storage Location</label>
        <div class="input-group">
          <i class="fas fa-map-marker-alt"></i>
          <select id="location" name="location" required>
            <option value="">Select Location...</option>
            <option>Front side</option><option>Back side</option><option>On Display</option>
          </select>
        </div>
      </div>

      <div class="form-step" id="step4">
        <label>Confirm Details</label>
        <div class="product-details"><div class="product-name" id="final-product-name"></div></div>
        <div class="review-summary">
            <div class="review-item"><i class="fas fa-barcode"></i> <span id="review-barcode"></span></div>
            <div class="review-item"><i class="fas fa-user"></i> <span id="review-identity"></span></div>
            <div class="review-item"><i class="fas fa-hashtag"></i> Qty: <span id="review-quantity"></span></div>
            <div class="review-item"><i class="fas fa-calendar-alt"></i> <span id="review-expiryDate"></span></div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" id="prevBtn" class="prev-button" onclick="prevStep()" disabled><i class="fas fa-arrow-left"></i> Back</button>
        <button type="button" id="nextBtn" class="next-button" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button>
        <button type="submit" id="logItemBtn" class="log-button" style="display: none;"><i class="fas fa-check-circle"></i> Submit</button>
      </div>
    </form>
  </div>

  <div class="loader-overlay" id="loader"><div class="loader-spinner"></div><span>Processing...</span></div>
  <div id="scanner-container"><div id="reader"></div><button id="close-scanner" onclick="stopScanner()">Close Camera</button></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby__866_Y_0XFiaPPCUaX6U1oZK329Ek6SRg9iU4u-aq5ARhxmkTmIHq6gvTpxXMf-8Lw/exec";
    const LOCAL_DB_KEY = 'inventory_product_db', DB_VERSION_KEY = 'inventory_db_version', OFFLINE_QUEUE_KEY = 'inventory_offline_queue';

    const form = document.getElementById("inventoryForm"), steps = document.querySelectorAll(".form-step"), prevBtn = document.getElementById("prevBtn"), nextBtn = document.getElementById("nextBtn"), logItemBtn = document.getElementById("logItemBtn"), progressBarFill = document.querySelector(".progress-bar-fill"), currentStepText = document.getElementById("currentStepText"), loader = document.getElementById("loader"), refreshBtn = document.getElementById("refreshBtn"), barcodeInput = document.getElementById("barcode");
    
    let currentStep = 0, isProductFound = false, productDetails = {}, productMap = {}, html5QrCodeScanner = null;
    const stepTitles = ["Scan", "Details", "Location", "Review"];

    function showToast(m, t = 'success') {
      const c = document.getElementById('toast-container'), toast = document.createElement('div');
      toast.className = `toast ${t}`;
      toast.innerHTML = `<i class="fas fa-${t==='success'?'check-circle':t==='error'?'times-circle':'exclamation-triangle'}"></i> <span>${m}</span>`;
      c.appendChild(toast);
      setTimeout(() => { toast.classList.add('fade-out'); toast.addEventListener('animationend', () => toast.remove()); }, 3500);
    }

    window.onload = function() {
      showStep(0);
      document.getElementById("expiryDate").valueAsDate = new Date();
      document.getElementById("scannerIcon").addEventListener('click', startScanner);
      barcodeInput.addEventListener('input', () => { updateNavigationButtons(); performBarcodeLookup(); });
      loadLocalDB();
      updateQueueDisplay();
      checkOnlineStatus();
      window.addEventListener('online', () => { checkOnlineStatus(); syncQueue(); });
      window.addEventListener('offline', checkOnlineStatus);
      if(navigator.onLine) { forceUpdateDB(); syncQueue(); }
    };

    function checkOnlineStatus() {
      const el = document.getElementById('connectionStatus');
      el.className = `status-badge status-${navigator.onLine?'online':'offline'}`;
      el.innerText = navigator.onLine ? 'Online' : 'Offline';
    }

    function loadLocalDB() {
      const saved = localStorage.getItem(LOCAL_DB_KEY);
      if (saved) productMap = JSON.parse(saved);
    }

    function forceUpdateDB() {
      if(!navigator.onLine) return;
      refreshBtn.classList.add('is-loading');
      refreshBtn.disabled = true;

      fetch(API_URL + "?action=getProducts")
        .then(res => res.json())
        .then(data => {
          if(String(data.version) !== localStorage.getItem(DB_VERSION_KEY)) {
            localStorage.setItem(LOCAL_DB_KEY, JSON.stringify(data.products));
            localStorage.setItem(DB_VERSION_KEY, data.version);
            productMap = data.products;
            showToast("Database Synced");
          }
        })
        .finally(() => {
          setTimeout(() => {
            refreshBtn.classList.remove('is-loading');
            refreshBtn.disabled = false;
          }, 500); // Small delay for visual smoothness
        });
    }

    function performBarcodeLookup() {
      const b = barcodeInput.value.trim();
      if (productMap[b]) {
        productDetails = { productName: productMap[b], barcode: b };
        isProductFound = true;
      } else {
        productDetails = { productName: "Unknown Product", barcode: b };
        isProductFound = false;
      }
      document.getElementById("product-name-summary2").innerText = productDetails.productName;
      document.getElementById("barcode-summary2").innerText = productDetails.barcode;
      document.getElementById("product-details-display-step2").style.display = b ? 'block' : 'none';
    }

    function showStep(idx) {
      steps.forEach((s, i) => s.classList.toggle('active', i === idx));
      prevBtn.disabled = idx === 0;
      nextBtn.style.display = idx === steps.length - 1 ? 'none' : 'flex';
      logItemBtn.style.display = idx === steps.length - 1 ? 'flex' : 'none';
      progressBarFill.style.width = `${((idx + 1) / steps.length) * 100}%`;
      currentStepText.innerText = stepTitles[idx];
      updateNavigationButtons();
    }

    function nextStep() {
      if (currentStep === 0) {
        performBarcodeLookup();
        if(!isProductFound) { showToast("Product not found!", "error"); return; }
      }
      currentStep++; showStep(currentStep);
      if(currentStep === 3) populateReview();
    }

    function prevStep() { currentStep--; showStep(currentStep); }

    function setType(t) {
      document.getElementById("entryType").value = t;
      document.getElementById("expBtn").classList.toggle('selected', t === 'Expiry');
      document.getElementById("dmgBtn").classList.toggle('selected', t === 'Damage');
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
        if(currentStep === 0) nextBtn.disabled = !barcodeInput.value.trim();
        if(currentStep === 1) nextBtn.disabled = !document.getElementById("identity").value || !document.getElementById("entryType").value;
        if(currentStep === 2) nextBtn.disabled = !document.getElementById("location").value;
    }

    function populateReview() {
      document.getElementById("final-product-name").innerText = productDetails.productName;
      document.getElementById("review-barcode").innerText = barcodeInput.value;
      document.getElementById("review-identity").innerText = document.getElementById("identity").value;
      document.getElementById("review-quantity").innerText = document.getElementById("quantity").value;
      document.getElementById("review-expiryDate").innerText = document.getElementById("expiryDate").value;
    }

    form.onsubmit = e => {
      e.preventDefault();
      const item = {
        barcode: barcodeInput.value.trim(),
        quantity: document.getElementById("quantity").value,
        expiryDate: document.getElementById("expiryDate").value,
        location: document.getElementById("location").value,
        identity: document.getElementById("identity").value,
        type: document.getElementById("entryType").value,
        productName: productDetails.productName,
        timestamp: new Date().toISOString()
      };

      if(navigator.onLine) {
        loader.classList.add('active');
        fetch(API_URL, { method: 'POST', body: JSON.stringify(item) })
          .then(() => { showToast("Logged successfully"); resetForm(); })
          .catch(() => saveOffline(item))
          .finally(() => loader.classList.remove('active'));
      } else {
        saveOffline(item);
      }
    };

    function saveOffline(item) {
      const q = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || "[]");
      q.push(item);
      localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(q));
      updateQueueDisplay();
      showToast("Saved offline", "warning");
      resetForm();
    }

    function syncQueue() {
      const q = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || "[]");
      if(!q.length) return;
      fetch(API_URL, { method: 'POST', body: JSON.stringify(q[0]) })
        .then(() => { q.shift(); localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(q)); updateQueueDisplay(); syncQueue(); });
    }

    function updateQueueDisplay() {
      document.getElementById("queueCount").innerText = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || "[]").length;
    }

    function resetForm() {
      form.reset(); currentStep = 0; showStep(0);
      document.getElementById("product-details-display-step2").style.display = 'none';
      document.querySelectorAll('.type-button').forEach(b => b.classList.remove('selected'));
      document.getElementById("expiryDate").valueAsDate = new Date();
    }

    function startScanner() {
      document.getElementById("scanner-container").style.display = 'flex';
      html5QrCodeScanner = new Html5Qrcode("reader");
      html5QrCodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, text => {
        barcodeInput.value = text; stopScanner(); performBarcodeLookup();
        if(productMap[text]) nextStep(); else showToast("Not found", "error");
      });
    }

    function stopScanner() {
      if(html5QrCodeScanner) html5QrCodeScanner.stop().then(() => { 
          document.getElementById("scanner-container").style.display = 'none'; 
          html5QrCodeScanner = null; 
      });
    }
  </script>
</body>
</html>
